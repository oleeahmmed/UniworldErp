{% extends "base.html" %}

{% block title %}Sales Order Report{% endblock %}

{% block main_content %}
<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Sales Order Report</h1>
    
    <!-- Filter Form -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label for="customer" class="block text-sm font-medium text-gray-700">Customer</label>
                <select name="customer" id="customer" 
                        class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <option value="">All Customers</option>
                    {% for customer in customers %}
                        <option value="{{ customer.id }}" {% if customer.id|stringformat:"s" == selected_customer %}selected{% endif %}>
                            {{ customer.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label for="start_date" class="block text-sm font-medium text-gray-700">Start Date</label>
                <input type="date" name="start_date" id="start_date" value="{{ start_date }}" 
                       class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            
            <div>
                <label for="end_date" class="block text-sm font-medium text-gray-700">End Date</label>
                <input type="date" name="end_date" id="end_date" value="{{ end_date }}" 
                       class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            
            <div class="flex items-end">
                <button type="submit" 
                        class="btn btn-primary bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Filter
                </button>
                <a href="{% url 'sales_order_report' %}" 
                   class="btn btn-secondary bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded ml-2">
                    Clear
                </a>
                <a href="{% url 'sales_order_report_print' %}?customer={{ selected_customer }}&start_date={{ start_date }}&end_date={{ end_date }}" 
                   target="_blank"
                   class="btn btn-print bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded ml-2"
                   title="Print Sales Order Report">
                    <i class="fas fa-print"></i> Print
                </a>
                <a href="{% url 'sales_order_report_excel' %}?customer={{ selected_customer }}&start_date={{ start_date }}&end_date={{ end_date }}" 
                   class="btn btn-excel bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded ml-2"
                   title="Export to Excel">
                    <i class="fas fa-file-excel"></i> Excel
                </a>
                <button type="button" 
                        onclick="exportTableToCSV('sales_order_report.csv')"
                        class="btn btn-csv bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded ml-2"
                        title="Export to CSV">
                    <i class="fas fa-file-csv"></i> CSV
                </button>
            </div>
        </form>
    </div>
    
    <!-- Customer Information Header -->
    {% if customer_info %}
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <h3 class="text-lg font-semibold">Customer Information</h3>
                <p class="text-gray-700"><strong>Name:</strong> {{ customer_info.name }}</p>
                <p class="text-gray-700"><strong>Mobile:</strong> {{ customer_info.phone_number }}</p>
                <p class="text-gray-700"><strong>Business Type:</strong> {{ customer_info.business_type|title }}</p>
            </div>
            <div>
                <h3 class="text-lg font-semibold">Address</h3>
                <p class="text-gray-700">{{ customer_info.address|default:"N/A" }}</p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Report Summary -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <div class="flex justify-between items-center">
            <h2 class="text-xl font-semibold">Report Summary</h2>
            <div class="text-gray-600 grid grid-cols-2 md:grid-cols-3 gap-4">
                <span>Total Orders: <span class="font-bold">{{ total_orders }}</span></span>
                <span>Gross Sold: <span class="font-bold">{{ total_gross_qty|default:0 }}</span></span>
                <span>Qty Returned: <span class="font-bold">{{ total_returned_qty|default:0 }}</span></span>
                <span>Net Qty: <span class="font-bold">{{ total_net_qty|default:0 }}</span></span>
                <span>Gross Amount: <span class="font-bold">{{ total_gross_amount|floatformat:2|default:0 }}</span></span>
                <span>Return Amount: <span class="font-bold">{{ total_returned_amount|floatformat:2|default:0 }}</span></span>
                <span>Net Amount: <span class="font-bold">{{ total_net_amount|floatformat:2|default:0 }}</span></span>
            </div>
        </div>
    </div>
    
    <!-- Sales Order Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order Date</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gross Sold</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty Returned</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Net Qty</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gross Amount</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Return Amount</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Net Amount</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sales Employee</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for order in sales_orders %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ order.order_date|date:"Y-m-d" }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ order.id }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ order.customer.name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ order.gross_qty|default:0 }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ order.returned_qty|default:0 }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ order.net_qty|default:0 }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ order.gross_amount|floatformat:2|default:0 }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ order.returned_amount|floatformat:2|default:0 }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ order.net_amount|floatformat:2|default:0 }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ order.sales_employee.full_name|default:"N/A" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="px-6 py-4 text-center text-sm text-gray-500">
                        No sales orders found.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // Set default dates to current month
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');
        
        if (!startDateInput.value) {
            startDateInput.valueAsDate = firstDay;
        }
        
        if (!endDateInput.value) {
            endDateInput.valueAsDate = today;
        }
    });
    
    // CSV Export Function
    function exportTableToCSV(filename) {
        const csv = [];
        const rows = document.querySelectorAll("table tr");
        
        // Add header row
        csv.push(['Order Date', 'Order ID', 'Customer', 'Gross Sold', 'Qty Returned', 'Net Qty', 'Gross Amount', 'Return Amount', 'Net Amount', 'Sales Employee'].join(','));
        
        // Add data rows
        {% for order in sales_orders %}
        csv.push([
            '{{ order.order_date|date:"Y-m-d" }}',
            '{{ order.id }}',
            '{{ order.customer.name }}',
            '{{ order.gross_qty|default:0 }}',
            '{{ order.returned_qty|default:0 }}',
            '{{ order.net_qty|default:0 }}',
            '{{ order.gross_amount|floatformat:2|default:0 }}',
            '{{ order.returned_amount|floatformat:2|default:0 }}',
            '{{ order.net_amount|floatformat:2|default:0 }}',
            '{{ order.sales_employee.full_name|default:"N/A" }}'
        ].join(','));
        {% endfor %}
        
        // Download CSV file
        const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
        const downloadLink = document.createElement('a');
        downloadLink.download = filename;
        downloadLink.href = window.URL.createObjectURL(csvFile);
        downloadLink.style.display = 'none';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    }
</script>
{% endblock %}
