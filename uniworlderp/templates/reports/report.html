{% extends "base.html" %}
<style>
    .tab-button {
        color: white !important;
    }
    .tab-button.active {
        background-color: white !important;
        color: #1f2937 !important;
    }
</style>
{% block main_content %}
<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Sales Report</h1>

    <!-- Tabs Navigation -->
    <div class="mb-6">
      <nav class="relative flex space-x-1 rounded-xl bg-gradient-to-r from-[#480d0f] to-[#000000] p-1 shadow-lg" aria-label="Tabs Navigation">
        <button type="button" class="tab-button w-full border-b-2 border-transparent py-4 px-1 text-sm font-medium text-white bg-transparent rounded-lg hover:bg-[#480d0f] transition-all" data-tab="report">
          Report
        </button>
        <button type="button" class="tab-button w-full border-b-2 border-transparent py-4 px-1 text-sm font-medium text-white bg-transparent rounded-lg hover:bg-[#480d0f] transition-all" data-tab="customer-summary">
          Total Amount by Customer
        </button>
        <button type="button" class="tab-button w-full border-b-2 border-transparent py-4 px-1 text-sm font-medium text-white bg-transparent rounded-lg hover:bg-[#480d0f] transition-all" data-tab="product-summary">
          Total Amount by Product
        </button>
        <button type="button" class="tab-button w-full border-b-2 border-transparent py-4 px-1 text-sm font-medium text-white bg-transparent rounded-lg hover:bg-[#480d0f] transition-all" data-tab="sales-employee-summary">
          Total Amount by Sales Employee
        </button>
        <button type="button" class="tab-button w-full border-b-2 border-transparent py-4 px-1 text-sm font-medium text-white bg-transparent rounded-lg hover:bg-[#480d0f] transition-all" data-tab="date-summary">
          Total Amount by Date
        </button>
        <button type="button" class="tab-button w-full border-b-2 border-transparent py-4 px-1 text-sm font-medium text-white bg-transparent rounded-lg hover:bg-[#480d0f] transition-all" data-tab="product-wise-report">
          Product-wise Report
        </button>
        <button type="button" class="tab-button w-full border-b-2 border-transparent py-4 px-1 text-sm font-medium text-white bg-transparent rounded-lg hover:bg-[#480d0f] transition-all" data-tab="customer-wise-report">
          Customer-wise Report
        </button>
      </nav>
    </div>

    <!-- Tab Contents -->
    <div class="tab-content active" id="report">
        <form method="post" class="mb-4">
            {% csrf_token %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label for="customer" class="block text-sm font-medium text-gray-700">Customer</label>
                    <select name="customer" id="customer" class="form-input mt-1 block w-full">
                        <option value="">All Customers</option>
                        {% for customer in customers %}
                            <option value="{{ customer.id }}" {% if customer.id|stringformat:"s" == request.POST.customer %}selected{% endif %}>{{ customer.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="product" class="block text-sm font-medium text-gray-700">Product</label>
                    <select name="product" id="product" class="form-input mt-1 block w-full">
                        <option value="">All Products</option>
                        {% for product in products %}
                            <option value="{{ product.id }}" {% if product.id|stringformat:"s" == selected_product_id|stringformat:"s" %}selected{% endif %}>{{ product.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="sales_employee" class="block text-sm font-medium text-gray-700">Sales Employee</label>
                    <select name="sales_employee" id="sales_employee" class="form-input mt-1 block w-full">
                        <option value="">All Sales Employees</option>
                        {% for employee in sales_employees %}
                            <option value="{{ employee.id }}" {% if employee.id|stringformat:"s" == request.POST.sales_employee %}selected{% endif %}>{{ employee.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="start_date" class="block text-sm font-medium text-gray-700">Start Date</label>
                    <input type="date" name="start_date" id="start_date" class="form-input mt-1 block w-full" value="{{ start_date|default:'' }}">
                </div>
                <div>
                    <label for="end_date" class="block text-sm font-medium text-gray-700">End Date</label>
                    <input type="date" name="end_date" id="end_date" class="form-input mt-1 block w-full" value="{{ end_date|default:'' }}">
                </div>
            </div>
            <button type="submit" class="btn-primary mt-4">Generate Report</button>
        </form>

        <!-- Unified Sales Report Table - Item Level Display -->
        <div class="overflow-x-auto bg-white shadow-md rounded-lg mt-6 p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Sales Report Table</h2>
                <div class="flex gap-2">
                    <button type="button" onclick="printReport()" class="btn-secondary">Print Report</button>
                    <button type="button" class="export-button btn-secondary" data-table-id="salesReportTable">Export as CSV</button>
                </div>
            </div>
            <table id="salesReportTable" class="w-full text-sm text-left text-gray-800 border-collapse">
                <thead class="text-xs uppercase bg-gradient-to-r from-[#480d0f] to-[#000000] text-white">
                    <tr>
                        <th scope="col" class="px-6 py-3 border-b">Date</th>
                        <th scope="col" class="px-6 py-3 border-b">Sales Order No</th>
                        <th scope="col" class="px-6 py-3 border-b">Customer Name</th>
                        <th scope="col" class="px-6 py-3 border-b">Product Name</th>
                        <th scope="col" class="px-6 py-3 border-b">Quantity</th>
                        <th scope="col" class="px-6 py-3 border-b">Unit</th>
                        <th scope="col" class="px-6 py-3 border-b">Price</th>
                        <th scope="col" class="px-6 py-3 border-b">Total</th>
                        <th scope="col" class="px-6 py-3 border-b">Sales Employee</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in report_items %}
                    <tr class="border-b border-gray-300 hover:bg-gray-100 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">{{ item.sales_order.order_date|date:"M d, Y" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ item.sales_order.id }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ item.sales_order.customer.name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ item.product.name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ item.quantity }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ item.product.get_unit_display }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ item.unit_price|floatformat:2 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ item.discounted_total|default:item.total|floatformat:2 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ item.sales_order.sales_employee.full_name }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="px-6 py-4 text-center text-sm text-gray-500">No sales data found for the selected criteria.</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-right font-bold">Total:</td>
                        <td class="px-6 py-4 font-bold" id="salesReportTotal"></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div class="tab-content hidden" id="customer-summary">
        <div class="overflow-x-auto bg-white shadow-md rounded-lg mt-6 p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Total Amount by Customer</h3>
                <button type="button" class="export-button btn-secondary" data-table-id="customerSummaryTable">Export as CSV</button>
            </div>
            <table id="customerSummaryTable" class="w-full text-sm text-left text-gray-800 border-collapse">
                <thead class="text-xs uppercase bg-gradient-to-r from-[#480d0f] to-[#000000] text-white">
                    <tr>
                        <th class="px-6 py-3 border-b">Customer</th>
                        <th class="px-6 py-3 border-b">Total Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for summary in customer_summary %}
                    <tr class="border-b border-gray-300 hover:bg-gray-100 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">{{ summary.sales_order__customer__name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ summary.total_amount|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" class="px-6 py-4 text-center text-sm text-gray-500">No data available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td class="px-6 py-4 text-right font-bold">Total:</td>
                        <td class="px-6 py-4 font-bold" id="customerSummaryTotal"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div class="tab-content hidden" id="product-summary">
        <div class="overflow-x-auto bg-white shadow-md rounded-lg mt-6 p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Total Amount by Product</h3>
                <button type="button" class="export-button btn-secondary" data-table-id="productSummaryTable">Export as CSV</button>
            </div>
            <table id="productSummaryTable" class="w-full text-sm text-left text-gray-800 border-collapse">
                <thead class="text-xs uppercase bg-gradient-to-r from-[#480d0f] to-[#000000] text-white">
                    <tr>
                        <th class="px-6 py-3 border-b">Product</th>
                        <th class="px-6 py-3 border-b">Total Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for summary in product_summary %}
                    <tr class="border-b border-gray-300 hover:bg-gray-100 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">{{ summary.product__name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ summary.total_amount|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" class="px-6 py-4 text-center text-sm text-gray-500">No data available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td class="px-6 py-4 text-right font-bold">Total:</td>
                        <td class="px-6 py-4 font-bold" id="productSummaryTotal"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div class="tab-content hidden" id="sales-employee-summary">
        <div class="overflow-x-auto bg-white shadow-md rounded-lg mt-6 p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Total Amount by Sales Employee</h3>
                <button type="button" class="export-button btn-secondary" data-table-id="salesEmployeeSummaryTable">Export as CSV</button>
            </div>
            <table id="salesEmployeeSummaryTable" class="w-full text-sm text-left text-gray-800 border-collapse">
                <thead class="text-xs uppercase bg-gradient-to-r from-[#480d0f] to-[#000000] text-white">
                    <tr>
                        <th class="px-6 py-3 border-b">Sales Employee</th>
                        <th class="px-6 py-3 border-b">Total Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for summary in sales_employee_summary %}
                    <tr class="border-b border-gray-300 hover:bg-gray-100 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">{{ summary.sales_order__sales_employee__full_name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ summary.total_amount|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" class="px-6 py-4 text-center text-sm text-gray-500">No data available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td class="px-6 py-4 text-right font-bold">Total:</td>
                        <td class="px-6 py-4 font-bold" id="salesEmployeeSummaryTotal"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div class="tab-content hidden" id="date-summary">
        <div class="overflow-x-auto bg-white shadow-md rounded-lg mt-6 p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Total Amount by Date</h3>
                <button type="button" class="export-button btn-secondary" data-table-id="dateSummaryTable">Export as CSV</button>
            </div>
            <table id="dateSummaryTable" class="w-full text-sm text-left text-gray-800 border-collapse">
                <thead class="text-xs uppercase bg-gradient-to-r from-[#480d0f] to-[#000000] text-white">
                    <tr>
                        <th class="px-6 py-3 border-b">Date</th>
                        <th class="px-6 py-3 border-b">Total Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for summary in date_summary %}
                    <tr class="border-b border-gray-300 hover:bg-gray-100 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">{{ summary.sales_order__order_date|date:"M d, Y" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ summary.total_amount|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" class="px-6 py-4 text-center text-sm text-gray-500">No data available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td class="px-6 py-4 text-right font-bold">Total:</td>
                        <td class="px-6 py-4 font-bold" id="dateSummaryTotal"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    
    <!-- Product-wise Report Tab -->
    <div class="tab-content hidden" id="product-wise-report">
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h3 class="text-lg font-semibold mb-4">Product-wise Sales Report</h3>
            <form id="product-wise-form">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="pw-product" class="block text-sm font-medium text-gray-700">Product</label>
                        <select name="product" id="pw-product" class="form-input mt-1 block w-full" required>
                            <option value="">Select Product</option>
                            {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }} ({{ product.sku }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="pw-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                        <input type="date" name="start_date" id="pw-start-date" class="form-input mt-1 block w-full" required>
                    </div>
                    <div>
                        <label for="pw-end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                        <input type="date" name="end_date" id="pw-end-date" class="form-input mt-1 block w-full" required>
                    </div>
                </div>
                <div class="mt-4">
                    <button type="button" onclick="generateProductWiseReport()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Generate Report
                    </button>
                </div>
            </form>
        </div>
        <div id="product-wise-results" class="hidden">
            <!-- Results will be loaded here -->
        </div>
    </div>
    
    <!-- Customer-wise Report Tab -->
    <div class="tab-content hidden" id="customer-wise-report">
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h3 class="text-lg font-semibold mb-4">Customer-wise Sales Report</h3>
            <form id="customer-wise-form">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="cw-customer" class="block text-sm font-medium text-gray-700">Customer</label>
                        <select name="customer" id="cw-customer" class="form-input mt-1 block w-full" required>
                            <option value="">Select Customer</option>
                            {% for customer in customers %}
                                <option value="{{ customer.id }}">{{ customer.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="cw-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                        <input type="date" name="start_date" id="cw-start-date" class="form-input mt-1 block w-full" required>
                    </div>
                    <div>
                        <label for="cw-end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                        <input type="date" name="end_date" id="cw-end-date" class="form-input mt-1 block w-full" required>
                    </div>
                </div>
                <div class="mt-4">
                    <button type="button" onclick="generateCustomerWiseReport()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Generate Report
                    </button>
                </div>
            </form>
        </div>
        <div id="customer-wise-results" class="hidden">
            <!-- Results will be loaded here -->
        </div>
    </div>
</div>

<script>
// Print Report function for main sales report
function printReport() {
    // Get filter values for header
    const customerSelect = document.getElementById('customer');
    const productSelect = document.getElementById('product');
    const employeeSelect = document.getElementById('sales_employee');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    const customerName = customerSelect && customerSelect.selectedIndex > 0 ? customerSelect.options[customerSelect.selectedIndex].text : 'All Customers';
    const productName = productSelect && productSelect.selectedIndex > 0 ? productSelect.options[productSelect.selectedIndex].text : 'All Products';
    const employeeName = employeeSelect && employeeSelect.selectedIndex > 0 ? employeeSelect.options[employeeSelect.selectedIndex].text : 'All Employees';
    const startDate = startDateInput ? startDateInput.value || 'All' : 'All';
    const endDate = endDateInput ? endDateInput.value || 'All' : 'All';
    
    // Get the report table
    const reportTable = document.getElementById('salesReportTable');
    if (!reportTable) {
        alert('Report table not found.');
        return;
    }
    
    // Create print window with full context
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Sales Report</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                .header { text-align: center; margin-bottom: 20px; }
                .header h1 { margin: 0 0 10px 0; color: #333; }
                .filter-info { margin-bottom: 15px; font-size: 12px; background: #f5f5f5; padding: 10px; border-radius: 5px; }
                .filter-info p { margin: 3px 0; }
                table { width: 100%; border-collapse: collapse; font-size: 11px; }
                th { background: #333; color: white; padding: 8px; text-align: left; }
                td { border: 1px solid #ddd; padding: 6px; }
                tbody tr:nth-child(even) { background-color: #f9f9f9; }
                tfoot td { font-weight: bold; background: #f5f5f5; }
                .footer { margin-top: 20px; font-size: 10px; text-align: right; border-top: 1px solid #ddd; padding-top: 10px; color: #666; }
                @media print {
                    body { padding: 0; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Sales Report</h1>
            </div>
            <div class="filter-info">
                <p><strong>Customer:</strong> ${customerName}</p>
                <p><strong>Product:</strong> ${productName}</p>
                <p><strong>Sales Employee:</strong> ${employeeName}</p>
                <p><strong>Date Range:</strong> ${startDate} to ${endDate}</p>
            </div>
            ${reportTable.outerHTML}
            <div class="footer">
                <p>Report Generated: ${new Date().toLocaleString()}</p>
                <p>Generated By: {{ user.username }}</p>
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// Tab functionality
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');
            
            // Hide all tab contents
            tabContents.forEach(content => {
                content.classList.add('hidden');
                content.classList.remove('active');
            });
            
            // Remove active class from all buttons and reset to white text
            tabButtons.forEach(btn => {
                btn.classList.remove('active', 'bg-white', 'text-gray-900', 'border-2', 'border-gray-300');
                btn.style.fontWeight = 'normal';
                btn.style.color = 'white';
                btn.style.backgroundColor = 'transparent';
            });
            
            // Show target tab content
            const targetContent = document.getElementById(targetTab);
            if (targetContent) {
                targetContent.classList.remove('hidden');
                targetContent.classList.add('active');
            }
            
            // Add active class to clicked button - white background with black text
            button.classList.add('active', 'bg-white', 'text-gray-900', 'border-2', 'border-gray-300');
            button.style.fontWeight = 'bold';
            button.style.color = '#1f2937';
            button.style.backgroundColor = 'white';
        });
    });
    
    // Set today's date as default for end date fields
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('pw-end-date').value = today;
    document.getElementById('cw-end-date').value = today;
    
    // Set first tab as active by default
    if (tabButtons.length > 0) {
        tabButtons[0].click();
    }
});

// Product-wise report generation
function generateProductWiseReport() {
    const form = document.getElementById('product-wise-form');
    const resultsDiv = document.getElementById('product-wise-results');
    const formData = new FormData(form);
    
    const product = formData.get('product');
    const startDate = formData.get('start_date');
    const endDate = formData.get('end_date');
    
    if (!product || !startDate || !endDate) {
        alert('Please fill in all required fields.');
        return;
    }
    
    // Add CSRF token
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    resultsDiv.classList.remove('hidden');
    resultsDiv.innerHTML = '<p class="text-center">Loading...</p>';
    
    fetch('{% url "customer_vendor:product_wise_report" %}', {
        method: 'POST',
        body: new URLSearchParams(formData),
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.text())
    .then(html => {
        resultsDiv.innerHTML = html;
    })
    .catch(error => {
        console.error('Error:', error);
        resultsDiv.innerHTML = '<p class="text-red-600 text-center">Error generating report. Please try again.</p>';
    });
}

// Customer-wise report generation
function generateCustomerWiseReport() {
    const form = document.getElementById('customer-wise-form');
    const resultsDiv = document.getElementById('customer-wise-results');
    const formData = new FormData(form);
    
    const customer = formData.get('customer');
    const startDate = formData.get('start_date');
    const endDate = formData.get('end_date');
    
    if (!customer || !startDate || !endDate) {
        alert('Please fill in all required fields.');
        return;
    }
    
    // Add CSRF token
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    resultsDiv.classList.remove('hidden');
    resultsDiv.innerHTML = '<p class="text-center">Loading...</p>';
    
    fetch('{% url "customer_vendor:customer_wise_report" %}', {
        method: 'POST',
        body: new URLSearchParams(formData),
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.text())
    .then(html => {
        resultsDiv.innerHTML = html;
    })
    .catch(error => {
        console.error('Error:', error);
        resultsDiv.innerHTML = '<p class="text-red-600 text-center">Error generating report. Please try again.</p>';
    });
}

// Global functions for product-wise report buttons
window.printProductReport = function(productId, startDate, endDate) {
    // Open print view in new window
    const url = '{% url "customer_vendor:product_wise_report_print" %}' + 
                '?product=' + productId + 
                '&start_date=' + startDate + 
                '&end_date=' + endDate;
    window.open(url, '_blank');
};

window.exportProductReport = function(productId, startDate, endDate) {
    // Export to Excel directly
    const url = '{% url "customer_vendor:product_wise_report_excel" %}' + 
                '?product=' + productId + 
                '&start_date=' + startDate + 
                '&end_date=' + endDate;
    window.open(url, '_blank');
};

// Global functions for customer-wise report buttons
window.printCustomerReport = function(customerId, startDate, endDate) {
    // Open print view in new window
    const url = '{% url "customer_vendor:customer_wise_report_print" %}' + 
                '?customer=' + customerId + 
                '&start_date=' + startDate + 
                '&end_date=' + endDate;
    window.open(url, '_blank');
};

window.exportCustomerReport = function(customerId, startDate, endDate) {
    // Export to Excel directly
    const url = '{% url "customer_vendor:customer_wise_report_excel" %}' + 
                '?customer=' + customerId + 
                '&start_date=' + startDate + 
                '&end_date=' + endDate;
    window.open(url, '_blank');
};

</script>

{% endblock %}

{% block extra_js %}
<script>
 // Table sorting functionality
 document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('salesReportTable');
    const headers = table.querySelectorAll('th');
    const tableBody = table.querySelector('tbody');
    const rows = tableBody.querySelectorAll('tr');

    const directions = Array.from(headers).map(() => '');

    const sortColumn = (index) => {
        const direction = directions[index] || 'asc';
        const multiplier = (direction === 'asc') ? 1 : -1;
        const newRows = Array.from(rows);

        newRows.sort((rowA, rowB) => {
            const cellA = rowA.querySelectorAll('td')[index].textContent.trim();
            const cellB = rowB.querySelectorAll('td')[index].textContent.trim();

            switch (index) {
                case 1: // Name
                case 2: // Email
                    return cellA.localeCompare(cellB) * multiplier;
                case 3: // Phone Number
                    return cellA.replace(/\D/g, '').localeCompare(cellB.replace(/\D/g, '')) * multiplier;
                default:
                    return 0;
            }
        });

        [].forEach.call(rows, (row) => {
            tableBody.removeChild(row);
        });

        newRows.forEach(newRow => tableBody.appendChild(newRow));

        directions[index] = direction === 'asc' ? 'desc' : 'asc';
    };

    [].forEach.call(headers, (header, index) => {
        if (index > 0 && index < 4) {
            header.addEventListener('click', () => {
                sortColumn(index);
            });
        }
    });

    // CSV Export functionality for all tables
    document.querySelectorAll('.export-button').forEach(button => {
        button.addEventListener('click', function() {
            const tableId = this.getAttribute('data-table-id');
            const table = document.getElementById(tableId);
            let csvContent = '';
            
            // Helper function to escape CSV values (handle commas, quotes, newlines)
            const escapeCSV = (value) => {
                if (value === null || value === undefined) return '';
                const stringValue = String(value).trim();
                // If value contains comma, quote, or newline, wrap in quotes and escape existing quotes
                if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                    return '"' + stringValue.replace(/"/g, '""') + '"';
                }
                return stringValue;
            };
            
            // Export headers from thead
            const headerRow = table.querySelector('thead tr');
            if (headerRow) {
                const headers = headerRow.querySelectorAll('th');
                const headerData = Array.from(headers).map(th => escapeCSV(th.textContent));
                csvContent += headerData.join(',') + '\n';
            }
            
            // Export data rows from tbody (excluding empty rows and footer)
            const bodyRows = table.querySelectorAll('tbody tr');
            bodyRows.forEach(row => {
                const cols = row.querySelectorAll('td');
                // Skip rows with colspan (like "No data" messages)
                if (cols.length > 1 || (cols.length === 1 && !cols[0].hasAttribute('colspan'))) {
                    const rowData = Array.from(cols).map(col => escapeCSV(col.textContent));
                    csvContent += rowData.join(',') + '\n';
                }
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${tableId}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    });

    // Function to calculate and display the total amount for each table
    // For salesReportTable, Total is at column index 7 (0-indexed)
    // For summary tables, Total is at the last column
    const calculateTotal = (tableId, totalId, columnIndex = null) => {
        const table = document.getElementById(tableId);
        if (!table) return;
        
        const rows = table.querySelectorAll('tbody tr');
        let total = 0;

        rows.forEach(row => {
            let amountCell;
            if (columnIndex !== null) {
                // Use specific column index for salesReportTable (Total column at index 7)
                amountCell = row.querySelectorAll('td')[columnIndex];
            } else {
                // Use last column for summary tables
                amountCell = row.querySelector('td:last-child');
            }
            if (amountCell) {
                const amount = parseFloat(amountCell.textContent.trim().replace(/[^0-9.-]+/g, ""));
                if (!isNaN(amount)) {
                    total += amount;
                }
            }
        });

        const totalElement = document.getElementById(totalId);
        if (totalElement) {
            totalElement.textContent = total.toFixed(2);
        }
    };

    // Calculate totals for each table
    // For salesReportTable, Total column is at index 7 (Date=0, Order No=1, Customer=2, Product=3, Qty=4, Unit=5, Price=6, Total=7, Employee=8)
    calculateTotal('salesReportTable', 'salesReportTotal', 7);
    calculateTotal('customerSummaryTable', 'customerSummaryTotal');
    calculateTotal('productSummaryTable', 'productSummaryTotal');
    calculateTotal('salesEmployeeSummaryTable', 'salesEmployeeSummaryTotal');
    calculateTotal('dateSummaryTable', 'dateSummaryTotal');
    
    // Add sorting functionality for single product transaction table if it exists
    const singleProductTable = document.getElementById('singleProductTransactionTable');
    if (singleProductTable) {
        const headers = singleProductTable.querySelectorAll('th');
        const tableBody = singleProductTable.querySelector('tbody');
        const rows = tableBody.querySelectorAll('tr');

        const directions = Array.from(headers).map(() => '');

        const sortColumn = (index) => {
            const direction = directions[index] || 'asc';
            const multiplier = (direction === 'asc') ? 1 : -1;
            const newRows = Array.from(rows);

            newRows.sort((rowA, rowB) => {
                const cellA = rowA.querySelectorAll('td')[index].textContent.trim();
                const cellB = rowB.querySelectorAll('td')[index].textContent.trim();

                switch (index) {
                    case 0: // Date
                        return new Date(cellA).getTime() - new Date(cellB).getTime() * multiplier;
                    case 1: // Order ID
                        return (parseInt(cellA) - parseInt(cellB)) * multiplier;
                    case 2: // Customer Name
                    case 6: // Sales Employee
                        return cellA.localeCompare(cellB) * multiplier;
                    case 3: // Quantity
                        return (parseInt(cellA) - parseInt(cellB)) * multiplier;
                    case 4: // Unit Price
                    case 5: // Total
                        return (parseFloat(cellA) - parseFloat(cellB)) * multiplier;
                    default:
                        return 0;
                }
            });

            [].forEach.call(rows, (row) => {
                tableBody.removeChild(row);
            });

            newRows.forEach(newRow => tableBody.appendChild(newRow));

            directions[index] = direction === 'asc' ? 'desc' : 'asc';
        };

        [].forEach.call(headers, (header, index) => {
            header.addEventListener('click', () => {
                sortColumn(index);
            });
            header.style.cursor = 'pointer';
        });
    }
});
</script>

<!-- Include PDF.js libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<!-- Include your PDF export script -->
<script >
    
import html2pdf from 'html2pdf.js';

document.addEventListener('DOMContentLoaded', function() {
  // Add PDF export buttons next to CSV export buttons
  document.querySelectorAll('.export-button').forEach(button => {
    const tableId = button.getAttribute('data-table-id');
    const exportContainer = button.parentElement;
    
    // Create PDF export button
    const pdfButton = document.createElement('button');
    pdfButton.type = 'button';
    pdfButton.className = button.className; // Use same styling as CSV button
    pdfButton.textContent = 'Export as PDF';
    
    // Insert PDF button after CSV button
    exportContainer.appendChild(pdfButton);
    
    // Add event listener for PDF export
    pdfButton.addEventListener('click', function() {
      const table = document.getElementById(tableId);
      const title = table.closest('.overflow-x-auto').querySelector('h2, h3').textContent;
      
      // Create a clone of the table container for PDF
      const container = document.createElement('div');
      container.style.padding = '20px';
      
      // Add title
      const titleElement = document.createElement('h2');
      titleElement.textContent = title;
      titleElement.style.marginBottom = '20px';
      titleElement.style.fontSize = '18px';
      container.appendChild(titleElement);
      
      // Clone the table and maintain styles
      const tableClone = table.cloneNode(true);
      container.appendChild(tableClone);
      
      // Configure pdf options
      const opt = {
        margin: 10,
        filename: `${title.toLowerCase().replace(/\s+/g, '-')}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
          scale: 2,
          useCORS: true,
          letterRendering: true
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'landscape'
        }
      };
      
      // Generate PDF
      html2pdf().from(container).set(opt).save();
    });
  });
});


</script>

<!-- Your existing JavaScript -->
<script>
  // Your existing table sorting code...
</script>
{% endblock %} 


